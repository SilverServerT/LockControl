<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnetic Lock Control</title>
    <link rel="icon" href="/local/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --accent: #388e3c;
            --danger: #d32f2f;
            --bg: #f0f2f5;
            --card-bg: #fff;
            --shadow: 0 4px 24px rgba(0,0,0,0.08);
            --radius: 18px;
            --transition: 0.2s cubic-bezier(.4,0,.2,1);
            --locked: #388e3c;    /* Green for locked (safe) */
            --unlocked: #d32f2f;  /* Red for unlocked (unsafe) */
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--bg);
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            transition: border-color 0.3s;
            border: 4px solid #bbb;
        }

        .container.locked {
            border-color: var(--locked);
        }

        .container.unlocked {
            border-color: var(--unlocked);
        }

        .container.unknown {
            border-color: #bbb;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .header h1 {
            font-size: 1.8em;
            color: var(--primary);
            margin: 0;
            font-weight: 500;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 20px 0;
            background: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: var(--radius);
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .info-item .material-icons {
            font-size: 1.2em;
            color: var(--primary);
        }

        .daily-code {
            width: 100%;
            background: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .daily-code-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .daily-code-header .material-icons {
            color: var(--primary);
        }

        .daily-code-header span {
            font-weight: 500;
            color: var(--primary);
        }

        .code-display {
            font-family: monospace;
            font-size: 1.5em;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 5px 0;
        }

        .code-expiry {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .lock-status {
            width: 100%;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.03);
            border-radius: var(--radius);
            border: 3px solid var(--unlocked);
            transition: border-color var(--transition);
        }

        .lock-status.locked {
            border-color: var(--locked);
        }

        .lock-status-text {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--unlocked);
            transition: color var(--transition);
        }

        .lock-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 10px;
            background: var(--unlocked);
            color: #fff;
            cursor: pointer;
            transition: all var(--transition);
            font-weight: 500;
            gap: 8px;
        }

        .lock-button .material-icons {
            font-size: 1.2em;
        }

        .lock-button:active {
            transform: scale(0.98);
        }

        .lock-button.locked {
            background: var(--locked);
        }

        @media (max-width: 600px) {
            .container {
                max-width: 100%;
                margin: 0;
                padding: 15px;
                min-height: 100vh;
                height: 100vh;
                overflow: hidden;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .info-bar {
                flex-wrap: wrap;
                gap: 10px;
                padding: 12px;
            }

            .info-item {
                flex: 1;
                min-width: 45%;
                justify-content: center;
            }
        }

        .duration-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .duration-buttons .lock-button {
            flex: 1;
            min-width: 80px;
            max-width: 120px;
            padding: 10px;
            font-size: 0.9em;
            background: var(--unlocked);
        }

        .duration-buttons .lock-button:hover {
            background: var(--unlocked);
            opacity: 0.9;
        }

        .duration-buttons .lock-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--shadow);
        }

        .success-message {
            background: var(--accent);
        }

        .error-message {
            background: var(--danger);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        #weatherInfo {
            text-align: left;
            line-height: 1.4;
        }

        @media (max-width: 600px) {
            .info-item {
                min-height: 60px;
            }
        }

        .friesland-card {
            width: 100%;
            background: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .friesland-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .friesland-header .material-icons {
            color: var(--primary);
        }

        .friesland-header span {
            font-weight: 500;
            color: var(--primary);
        }

        .brandweer-entry {
            display: flex;
            align-items: flex-start;
            margin: 4px 0;
            padding: 6px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            font-size: 0.8em;
        }

        .brandweer-entry .material-icons {
            font-size: 1.1em;
            margin-right: 6px;
            color: #d32f2f;
        }

        .brandweer-content {
            flex: 1;
        }

        .brandweer-time {
            font-size: 0.75em;
            color: #888;
            margin-top: 2px;
        }

        @media (max-width: 600px) {
            .brandweer-entry {
                font-size: 0.75em;
                padding: 4px;
                margin: 2px 0;
            }
            .brandweer-time {
                font-size: 0.7em;
            }
        }

        .lock-icon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
            padding: 20px;
            background: rgba(0,0,0,0.03);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            justify-content: center;
        }

        .lock-icon-container svg {
            transition: fill 0.3s, stroke 0.3s;
            width: 3.5rem;
            height: 3.5rem;
        }

        .status-text {
            text-align: center;
            font-size: 1.2em;
            font-weight: 500;
            margin-top: 1em;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .countdown-timer {
            text-align: center;
            font-size: 1.1em;
            margin: 15px 0 0 0;
            color: var(--primary-dark);
            font-weight: 500;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .countdown-timer .material-icons {
            font-size: 1.2em;
        }

        .countdown-timer.unavailable {
            color: #888;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .lock-icon-container {
                width: 80px;
                height: 80px;
                margin: 2px 0;
                padding: 15px;
            }
            .lock-icon-container svg {
                width: 2rem;
                height: 2rem;
            }
            .status-text {
                font-size: 1em;
                margin-top: 0.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container unknown" id="mainContainer">
        <div class="header">
            <h1>Magnetic Lock Control</h1>
        </div>

        <div class="lock-icon-container">
            <span id="lockIcon"></span>
            <div id="lockStatusText" class="status-text">Checking status...</div>
        </div>

        <div id="countdownTimer" class="countdown-timer" style="display: none;"></div>

        <button id="lockButton" class="lock-button" onclick="toggleLock()">
            <span class="material-icons">lock</span>
            Toggle Lock
        </button>
        <div class="duration-buttons">
            <button onclick="unlockForDuration(10)" class="lock-button">10s</button>
            <button onclick="unlockForDuration(300)" class="lock-button">5m</button>
            <button onclick="unlockForDuration(1800)" class="lock-button">30m</button>
            <button onclick="unlockUntilSunset()" class="lock-button">Until Sunset</button>
        </div>

        <!-- Add debug button -->
        <button onclick="clearAllStates()" class="lock-button" style="background: #ff9800; margin-top: 10px;">
            <span class="material-icons">cleaning_services</span>
            Clear All States (Debug)
        </button>

        <div class="daily-code">
            <div class="daily-code-header">
                <span class="material-icons">key</span>
                <span>Daily Code</span>
            </div>
            <div id="dailyCode" class="code-display">Loading...</div>
            <div id="dailyCodeExpiry" class="code-expiry"></div>
        </div>

        <div class="info-bar">
            <div class="info-item">
                <span class="material-icons">schedule</span>
                <span id="currentTime">--:--</span>
            </div>
            <div class="info-item">
                <span class="material-icons">calendar_today</span>
                <span id="currentDate">--</span>
            </div>
            <div class="info-item">
                <span class="material-icons">wb_sunny</span>
                <span id="sunsetTime">--:--</span>
            </div>
        </div>

        <div class="friesland-card">
            <div class="friesland-header">
                <span class="material-icons">warning</span>
                <span>Brandweer Status</span>
            </div>
            <div id="brandweerNotifications"></div>
            <div id="brandweerTimestamp" style="text-align: center; font-size: 0.8em; color: #888; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                <span class="material-icons" style="font-size: 1em;">update</span>
                --
            </div>
        </div>
    </div>

    <script>
        const config = {
            HA_TOKEN: '',
            HA_URL: window.location.origin.replace('http://', 'https://'),
            VERSION: '2.1.0',
            timezone: 'Europe/Amsterdam',
            tasmotaSwitch: 'switch.tasmota',
            stateEntities: {
                dailyCode: "input_text.lockcontrol_daily_code",
                dailyCodeExpiry: "input_datetime.lockcontrol_daily_code_expiry",
                friesland: "sensor.friesland",
                unlockEnd: "input_datetime.lock_unlock_end"
            }
        };

        let currentState = 'off';
        let unlockTimer = null;

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('nl-NL', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: config.timezone
            });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('nl-NL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: config.timezone
            });
        }

        function updateDailyCode() {
            if (!config.HA_TOKEN) {
                console.error('No token available');
                document.getElementById('dailyCode').textContent = 'Error: No token';
                return;
            }

            fetch(`${config.HA_URL}/api/states/${config.stateEntities.dailyCode}`, {
                headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const dailyCode = document.getElementById('dailyCode');
                const dailyCodeExpiry = document.getElementById('dailyCodeExpiry');
                
                if (data && data.state && data.state !== 'unknown') {
                    dailyCode.textContent = data.state;
                    
                    fetch(`${config.HA_URL}/api/states/${config.stateEntities.dailyCodeExpiry}`, {
                        headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
                    })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(expiryData => {
                        if (expiryData && expiryData.state) {
                            const expiry = new Date(expiryData.state);
                            dailyCodeExpiry.textContent = `Expires at ${expiry.toLocaleTimeString('nl-NL', { 
                                hour: '2-digit', 
                                minute: '2-digit', 
                                hour12: false,
                                timeZone: config.timezone 
                            })}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching expiry:', error);
                        dailyCodeExpiry.textContent = 'Error loading expiry';
                    });
                } else {
                    dailyCode.textContent = 'No code available';
                    dailyCodeExpiry.textContent = '';
                }
            })
            .catch(error => {
                console.error('Error fetching daily code:', error);
                document.getElementById('dailyCode').textContent = 'Error loading code';
            });
        }

        function getLockState() {
            if (!config.HA_TOKEN) {
                console.error('No token available');
                document.getElementById('lockStatusText').textContent = 'Error: No token';
                return;
            }

            fetch(`${config.HA_URL}/api/states/${config.tasmotaSwitch}`, {
                headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                currentState = data.state;
                updateLockStatus();
            })
            .catch(error => {
                console.error('Error fetching lock state:', error);
                document.getElementById('lockStatusText').textContent = 'Error fetching status';
                currentState = 'unknown';
                updateLockStatus();
            });
        }

        function updateLockStatus() {
            const lockButton = document.getElementById('lockButton');
            const lockStatusText = document.getElementById('lockStatusText');
            const lockIcon = document.getElementById('lockIcon');
            const mainContainer = document.getElementById('mainContainer');

            // Check if all required elements exist
            if (!lockButton || !lockStatusText || !lockIcon || !mainContainer) {
                console.error('Required elements not found:', {
                    lockButton: !!lockButton,
                    lockStatusText: !!lockStatusText,
                    lockIcon: !!lockIcon,
                    mainContainer: !!mainContainer
                });
                return;
            }
            
            if (currentState === 'on') {
                // Locked state
                lockButton.innerHTML = '<span class="material-icons">lock_open</span> Unlock Door';
                lockButton.className = 'lock-button';
                lockStatusText.textContent = 'Locked';
                lockIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#388e3c" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="width:3.5em;height:3.5em;"><rect x="3" y="11" width="18" height="10" rx="2" fill="#43a047" stroke="#388e3c"/><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="#388e3c" fill="none"/><circle cx="12" cy="16" r="2" fill="#fff"/></svg>`;
                mainContainer.className = 'container locked';
            } else if (currentState === 'off') {
                // Unlocked state
                lockButton.innerHTML = '<span class="material-icons">lock</span> Lock Door';
                lockButton.className = 'lock-button locked';
                lockStatusText.textContent = 'Unlocked';
                lockIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="width:3.5em;height:3.5em;"><rect x="3" y="11" width="18" height="10" rx="2" fill="#e53935" stroke="#d32f2f"/><path d="M7 11V7a5 5 0 0 1 10 0" stroke="#d32f2f" fill="none"/><circle cx="12" cy="16" r="2" fill="#fff"/></svg>`;
                mainContainer.className = 'container unlocked';
            } else {
                // Unknown state
                lockButton.innerHTML = '<span class="material-icons">lock</span> Toggle Lock';
                lockButton.className = 'lock-button';
                lockStatusText.textContent = 'Unknown';
                lockIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="width:3.5em;height:3.5em;"><rect x="3" y="11" width="18" height="10" rx="2" fill="#eee" stroke="#888"/><path d="M7 11V7a5 5 0 0 1 10 0" stroke="#888" fill="none"/><circle cx="12" cy="16" r="2" fill="#888"/></svg>`;
                mainContainer.className = 'container unknown';
            }
        }

        // Add loading indicator function
        function showLoading(show) {
            let loadingDiv = document.getElementById('loadingIndicator');
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;
                loadingDiv.innerHTML = `
                    <div class="spinner" style="
                        width: 20px;
                        height: 20px;
                        border: 3px solid #f3f3f3;
                        border-top: 3px solid var(--primary);
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    "></div>
                    Loading...
                `;
                document.body.appendChild(loadingDiv);
            }
            loadingDiv.style.display = show ? 'flex' : 'none';
        }

        // Add spinner animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Update toggleLock function
        async function toggleLock() {
            try {
                setDurationButtonsEnabled(false);
                showLoading(true);

                // For magnetic lock: ON = locked, OFF = unlocked
                if (currentState === 'on') {
                    // Unlocking - just turn off the switch
                    const response = await fetch(`${config.HA_URL}/api/services/switch/turn_off`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.HA_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            entity_id: config.tasmotaSwitch
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to unlock door');
                    }
                    
                    currentState = 'off';
                    updateLockStatus();
                    showSuccess('Door unlocked');
                } else if (currentState === 'off') {
                    // Locking - clear timer first, then lock
                    if (unlockTimer) {
                        clearInterval(unlockTimer);
                        unlockTimer = null;
                    }
                    
                    // Reset unlock end time in Home Assistant
                    await fetch(`${config.HA_URL}/api/services/input_datetime/set_datetime`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.HA_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            entity_id: config.stateEntities.unlockEnd,
                            datetime: "1970-01-01T00:00:00"
                        })
                    });
                    
                    // Hide countdown timer
                    document.getElementById('countdownTimer').style.display = 'none';
                    
                    // Now lock the door
                    const response = await fetch(`${config.HA_URL}/api/services/switch/turn_on`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.HA_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            entity_id: config.tasmotaSwitch
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to lock door');
                    }
                    
                    currentState = 'on';
                    updateLockStatus();
                    showSuccess('Door locked');
                }
            } catch (error) {
                console.error('Error toggling lock:', error);
                showError('Failed to toggle lock');
            } finally {
                setDurationButtonsEnabled(true);
                showLoading(false);
            }
        }

        // Load configuration from config file
        async function loadConfig() {
            try {
                console.log('Device info:', {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)
                });

                // Add cache-busting parameter and force reload
                const timestamp = new Date().getTime();
                const configPaths = [
                    `config.js?t=${timestamp}`,
                    `../config.js?t=${timestamp}`,
                    '/local/lockcontrol/config.js?t=' + timestamp,
                    '/local/config.js?t=' + timestamp
                ];

                let configLoaded = false;
                for (const path of configPaths) {
                    try {
                        console.log('Trying to load config from:', path);
                        const response = await fetch(path, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        
                        if (response.ok) {
                            const text = await response.text();
                            console.log('Successfully loaded config from:', path);
                            
                            // Try to find token in JavaScript format first
                            let match = text.match(/HA_TOKEN:\s*'([^']+)'/);
                            if (!match) {
                                match = text.match(/HA_TOKEN=([^\s]+)/);
                            }
                            
                            if (match) {
                                config.HA_TOKEN = match[1];
                                console.log('Token found and set from file');
                                
                                // Store token in localStorage as backup
                                try {
                                    localStorage.setItem('ha_token', config.HA_TOKEN);
                                    console.log('Token stored in localStorage');
                                } catch (e) {
                                    console.warn('Could not store token in localStorage:', e);
                                }
                            }

                            // Try to find URL in JavaScript format first
                            let urlMatch = text.match(/HA_URL:\s*'([^']+)'/);
                            if (!urlMatch) {
                                urlMatch = text.match(/HA_URL=([^\s]+)/);
                            }
                            
                            if (urlMatch) {
                                config.HA_URL = urlMatch[1];
                                console.log('URL found and set from file:', config.HA_URL);
                                
                                // Store URL in localStorage as backup
                                try {
                                    localStorage.setItem('ha_url', config.HA_URL);
                                    console.log('URL stored in localStorage');
                                } catch (e) {
                                    console.warn('Could not store URL in localStorage:', e);
                                }
                            }
                            
                            configLoaded = true;
                            break;
                        }
                    } catch (e) {
                        console.warn(`Failed to load config from ${path}:`, e);
                    }
                }

                if (!configLoaded) {
                    console.log('Failed to load config from any path, trying localStorage');
                    // Try to recover from localStorage
                    const storedToken = localStorage.getItem('ha_token');
                    const storedUrl = localStorage.getItem('ha_url');
                    
                    if (storedToken) {
                        console.log('Using token from localStorage');
                        config.HA_TOKEN = storedToken;
                    }
                    if (storedUrl) {
                        console.log('Using URL from localStorage');
                        config.HA_URL = storedUrl;
                    }
                    
                    if (!storedToken || !storedUrl) {
                        throw new Error('Could not load configuration from any source');
                    }
                }

                // Verify we have the required values
                if (!config.HA_TOKEN || !config.HA_URL) {
                    throw new Error('Missing required configuration values');
                }

                console.log('Configuration loaded successfully:', {
                    url: config.HA_URL,
                    hasToken: !!config.HA_TOKEN,
                    tokenLength: config.HA_TOKEN.length
                });

            } catch (error) {
                console.error('Error loading config:', error);
                document.getElementById('dailyCode').textContent = 'Error: Config not loaded';
                document.getElementById('lockStatusText').textContent = 'Error: Config not loaded';
                throw error;
            }
        }

        // Add a function to clear cache and reload
        function clearCacheAndReload() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload(true);
            } catch (e) {
                console.error('Error clearing cache:', e);
                window.location.reload(true);
            }
        }

        // Add clear cache button for mobile devices
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            const clearButton = document.createElement('button');
            clearButton.className = 'lock-button warning';
            clearButton.style.marginTop = '10px';
            clearButton.innerHTML = '<span class="material-icons">cleaning_services</span> Clear Cache & Reload';
            clearButton.onclick = clearCacheAndReload;
            document.querySelector('.container').appendChild(clearButton);
        }

        // Add unlock duration functions
        async function unlockForDuration(seconds) {
            try {
                setDurationButtonsEnabled(false);
                showLoading(true);
                
                // First unlock the door
                const unlockResponse = await fetch(`${config.HA_URL}/api/services/switch/turn_off`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: config.tasmotaSwitch
                    })
                });

                if (!unlockResponse.ok) {
                    throw new Error('Failed to unlock door');
                }

                // Update current state and UI immediately
                currentState = 'off';
                updateLockStatus();

                // Calculate and set the unlock end time
                const endTime = new Date(Date.now() + seconds * 1000);
                const year = endTime.getFullYear();
                const month = String(endTime.getMonth() + 1).padStart(2, '0');
                const day = String(endTime.getDate()).padStart(2, '0');
                const hours = String(endTime.getHours()).padStart(2, '0');
                const minutes = String(endTime.getMinutes()).padStart(2, '0');
                const secs = String(endTime.getSeconds()).padStart(2, '0');
                
                const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${secs}`;
                
                const timerResponse = await fetch(`${config.HA_URL}/api/services/input_datetime/set_datetime`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: config.stateEntities.unlockEnd,
                        datetime: formattedDate
                    })
                });

                if (!timerResponse.ok) {
                    throw new Error('Failed to set unlock timer');
                }

                showSuccess(`Door unlocked for ${seconds} seconds`);
                
                // Update countdown timer immediately
                updateCountdownTimer();
            } catch (error) {
                console.error('Error unlocking door:', error);
                showError('Failed to unlock door');
            } finally {
                setDurationButtonsEnabled(true);
                showLoading(false);
            }
        }

        async function unlockUntilSunset() {
            try {
                setDurationButtonsEnabled(false);
                showLoading(true);

                // Get sunset time
                const response = await fetch(`${config.HA_URL}/api/states/sun.sun`, {
                    headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch sunset time');
                }
                
                const data = await response.json();
                const sunset = new Date(data.attributes.next_setting);
                
                // First unlock the door
                await fetch(`${config.HA_URL}/api/services/switch/turn_off`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: config.tasmotaSwitch
                    })
                });

                // Set the unlock end time to sunset
                await fetch(`${config.HA_URL}/api/services/input_datetime/set_datetime`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: config.stateEntities.unlockEnd,
                        datetime: sunset.toISOString().replace('T', ' ').slice(0, 19)
                    })
                });

                showSuccess('Door unlocked until sunset');
                // Update UI
                getLockState();
            } catch (error) {
                console.error('Error unlocking door:', error);
                showError('Failed to unlock door');
            } finally {
                setDurationButtonsEnabled(true);
                showLoading(false);
            }
        }

        // Update Friesland sensor function
        async function updateFrieslandSensor() {
            try {
                // First get current state
                const response = await fetch(`${config.HA_URL}/api/states/${config.stateEntities.friesland}`, {
                    headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const currentData = await response.json();
                const brandweerNotifications = document.getElementById('brandweerNotifications');
                const brandweerTimestamp = document.getElementById('brandweerTimestamp');
                const timestamp = new Date().toLocaleTimeString('nl-NL', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false,
                    timeZone: config.timezone 
                });

                // Get history for last 24 hours
                const now = new Date();
                const startTime = new Date(now.getTime() - (24 * 60 * 60 * 1000));
                const historyResponse = await fetch(`${config.HA_URL}/api/history/period/${startTime.toISOString()}?filter_entity_id=${config.stateEntities.friesland}`, {
                    headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
                });

                if (!historyResponse.ok) {
                    throw new Error(`Failed to get history: ${historyResponse.status}`);
                }

                const historyData = await historyResponse.json();
                const historyEntries = historyData[0] || [];

                // Update timestamp
                brandweerTimestamp.innerHTML = `<span class="material-icons">update</span> ${timestamp}`;

                if (historyEntries.length > 0) {
                    // Get last 3 entries
                    const lastEntries = historyEntries.slice(-3).reverse();
                    
                    // Create entries
                    const entriesHTML = lastEntries.map(entry => {
                        const time = new Date(entry.last_updated).toLocaleTimeString('nl-NL', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                            timeZone: config.timezone
                        });
                        return `
                            <div class="brandweer-entry">
                                <span class="material-icons">warning</span>
                                <div class="brandweer-content">
                                    <div>${entry.state || 'Brandweer alert'}</div>
                                    <div class="brandweer-time">${time}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    brandweerNotifications.innerHTML = entriesHTML;
                    
                    // Show warning if current state indicates active alert
                    if (currentData && currentData.state && currentData.state !== 'none') {
                        showError('Brandweer sensor is active!');
                    }
                } else {
                    brandweerNotifications.innerHTML = `
                        <div class="brandweer-entry">
                            <span class="material-icons">check_circle</span>
                            <div class="brandweer-content">
                                <div>No active alerts</div>
                                <div class="brandweer-time">${timestamp}</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error updating Friesland sensor:', error);
                document.getElementById('brandweerNotifications').innerHTML = `
                    <div class="brandweer-entry">
                        <span class="material-icons">error</span>
                        <div class="brandweer-content">
                            <div>Error loading data</div>
                            <div class="brandweer-time">${new Date().toLocaleTimeString('nl-NL', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false,
                                timeZone: config.timezone
                            })}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Add success/error message functions
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Add function to enable/disable duration buttons
        function setDurationButtonsEnabled(enabled) {
            const buttons = document.querySelectorAll('.duration-buttons .lock-button');
            buttons.forEach(button => {
                button.disabled = !enabled;
            });
        }

        // Re-add the countdown timer function
        async function updateCountdownTimer() {
            try {
                const response = await fetch(`${config.HA_URL}/api/states/${config.stateEntities.unlockEnd}`, {
                    headers: { 'Authorization': `Bearer ${config.HA_TOKEN}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const countdownTimer = document.getElementById('countdownTimer');
                
                if (data && data.state) {
                    const unlockEnd = new Date(data.state);
                    const now = new Date();
                    const isManualUnlock = unlockEnd.getTime() === new Date("1970-01-01T00:00:00").getTime();
                    
                    if (!isManualUnlock && unlockEnd > now) {
                        const diff = unlockEnd - now;
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        if (hours > 0) {
                            countdownTimer.textContent = `Locks in ${hours}h ${minutes}m`;
                        } else if (minutes > 0) {
                            countdownTimer.textContent = `Locks in ${minutes}m ${seconds}s`;
                        } else {
                            countdownTimer.textContent = `Locks in ${seconds}s`;
                        }
                        countdownTimer.style.display = 'block';
                    } else if (!isManualUnlock && unlockEnd <= now) {
                        // Timer has expired, lock the door
                        if (currentState === 'off') {
                            const lockResponse = await fetch(`${config.HA_URL}/api/services/switch/turn_on`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${config.HA_TOKEN}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    entity_id: config.tasmotaSwitch
                                })
                            });

                            if (lockResponse.ok) {
                                currentState = 'on';
                                updateLockStatus();
                                showSuccess('Door locked');
                            }
                        }
                        countdownTimer.style.display = 'none';
                    } else {
                        countdownTimer.style.display = 'none';
                    }
                } else {
                    countdownTimer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating countdown timer:', error);
                document.getElementById('countdownTimer').style.display = 'none';
            }
        }

        // Add clear all states function
        async function clearAllStates() {
            try {
                showLoading(true);
                
                // Clear timer interval
                if (unlockTimer) {
                    clearInterval(unlockTimer);
                    unlockTimer = null;
                }
                
                // Reset unlock end time in Home Assistant
                await fetch(`${config.HA_URL}/api/services/input_datetime/set_datetime`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: config.stateEntities.unlockEnd,
                        datetime: "1970-01-01T00:00:00"
                    })
                });
                
                // Hide countdown timer
                document.getElementById('countdownTimer').style.display = 'none';
                
                // Force lock the door
                await fetch(`${config.HA_URL}/api/services/switch/turn_on`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: config.tasmotaSwitch
                    })
                });
                
                // Update UI
                currentState = 'on';
                updateLockStatus();
                showSuccess('All states cleared and door locked');
                
            } catch (error) {
                console.error('Error clearing states:', error);
                showError('Failed to clear states');
            } finally {
                showLoading(false);
            }
        }

        // Update the init function to include countdown timer updates
        async function init() {
            try {
                await loadConfig();
                updateDateTime();
                setInterval(updateDateTime, 1000);
                updateDailyCode();
                setInterval(updateDailyCode, 60000);
                updateFrieslandSensor();
                setInterval(updateFrieslandSensor, 300000); // Update every 5 minutes
                getLockState();
                setInterval(getLockState, 30000);
                // Add countdown timer updates
                updateCountdownTimer();
                setInterval(updateCountdownTimer, 1000); // Update every second
            } catch (error) {
                console.error('Error initializing:', error);
                document.getElementById('dailyCode').textContent = 'Error: Initialization failed';
                document.getElementById('lockStatusText').textContent = 'Error: Initialization failed';
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>